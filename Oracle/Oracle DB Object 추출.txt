=========================
table 생성
=========================
SET SERVEROUTPUT ON 
SET ECHO OFF
SET LINESIZE 30000
SET TRIMOUT ON
SET TRIMSPOOL ON
SET HEADING OFF
SET FEEDBACK OFF
SET PAGESIZE 3000
SET TERM OFF
set long 2000000000

-- Set all transform param to default
--DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'DEFAULT',TRUE);
-- No storage clause, it's not really beautiful :)
--DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'STORAGE',FALSE);
-- Suppress the partition clause
--DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'PARTITIONING',FALSE);


EXEC DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM, 'SQLTERMINATOR', TRUE);
EXEC DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'STORAGE',false);
EXEC DBMS_OUTPUT.ENABLE(1000000);

SPOOL TABLE_DDL.SQL
DECLARE
V_SQL CLOB := '';
BEGIN
    FOR C IN (SELECT * FROM USER_TABLES) LOOP    
        SELECT DBMS_METADATA.GET_DDL('TABLE',C.TABLE_NAME,'UPADM') INTO V_SQL FROM DUAL;
        DBMS_OUTPUT.PUT_LINE(V_SQL);
    END LOOP;
END;
/
SPOOL OFF
EXIT;

=========================
OBJECT 추출
=========================

SET ECHO OFF
SET TERM OFF
SET FEEDBACK OFF
SET SERVEROUTPUT ON
SET HEADING OFF
SET LINESIZE 30000
SET TRIMOUT ON
SET TRIMSPOOL ON
SET PAGESIZE 0
set long 2000000000
column res Format a20000
ALTER SESSION SET NLS_DATE_FORMAT = 'YY-MM-DD';

EXEC DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM, 'SQLTERMINATOR', TRUE);
EXEC DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM, 'PRETTY', TRUE);
EXEC DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM, 'TABLESPACE', TRUE);
EXEC DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM, 'SEGMENT_ATTRIBUTES', TRUE);
EXECUTE DBMS_METADATA.SET_TRANSFORM_PARAM(DBMS_METADATA.SESSION_TRANSFORM,'STORAGE',false);


SPOOL INDEX_DDL.SQL
SELECT DBMS_METADATA.GET_DDL('INDEX',index_name) as res from user_indexes;
SPOOL OFF

SPOOL PROCEDURE_DDL.SQL
SELECT DBMS_METADATA.GET_DDL('PROCEDURE',name) as res from (select distinct name from user_source where type='PROCEDURE');
SPOOL OFF

SPOOL FUNCTION_DDL.SQL
SELECT DBMS_METADATA.GET_DDL('FUNCTION',name) as res  from (select distinct name from user_source where type='FUNCTION');
SPOOL OFF

SPOOL SEQUENCE_DDL.SQL
SELECT DBMS_METADATA.GET_DDL('SEQUENCE',SEQUENCE_NAME) as res  from USER_SEQUENCES;
SPOOL OFF

SPOOL TABLE_DDL.SQL
SELECT DBMS_METADATA.GET_DDL('TABLE',TABLE_NAME,'UPADM') as res from USER_TABLES;
SPOOL OFF

SPOOL SYNONYM_DDL.SQL
SELECT DBMS_METADATA.GET_DDL ('SYNONYM', SYNONYM_NAME, OWNER) as res FROM   DBA_SYNONYMS WHERE  TABLE_OWNER = 'UPADM';
SPOOL OFF

SPOOL USER_DDL.SQL
SELECT DBMS_METADATA.GET_DDL('USER',USERNAME) AS METADATA FROM DBA_USERS WHERE USERNAME IN ('UAPIS','MIG','VAM','UAPIFS','PMH','UPADM');
SPOOL OFF

SPOOL USER_GRANT_DDL.SQL
SELECT DBMS_METADATA.GET_GRANTED_DDL('ROLE_GRANT',USERNAME ) FROM DBA_USERS WHERE USERNAME IN ('UAPIS','MIG','VAM','UAPIFS','PMH','UPADM');
SPOOL OFF

SPOOL USER_TAB_PRIV_DCL.SQL
BEGIN
    FOR C IN (SELECT * FROM USER_TAB_PRIVS WHERE GRANTEE IN ('PUBLIC','UAPIS','MIG','VAM','UAPIFS','PMH','UPADM') ORDER BY GRANTEE) LOOP
        DBMS_OUTPUT.PUT_LINE('GRANT '||C.PRIVILEGE||' ON '||C.GRANTOR||'.'||C.TABLE_NAME||' TO '||C.GRANTEE||';'); 
    END LOOP;
END;
/
SPOOL OFF

EXIT;

=========================
SEGMENT 내용만 제거
=========================
sed -i'' -r -e "s/SEGMENT CREATION IMMEDIATE|SEGMENT CREATION DEFERRED//" TABLE_DDL.SQL 
sed -i'' -r -e "s/SEGMENT CREATION IMMEDIATE|SEGMENT CREATION DEFERRED//" INDEX_DDL.SQL 
sed -i'' -r -e "s/SQL>.*//" *.SQL
sed -i'' -r -e "s/  2.*|  3.*|  4.*|  5.*|  6.*|PL\/SQL procedure successfully completed.//" *.SQL
PL/SQL procedure successfully completed.
=========================
파일들 실행
=========================
sqlplus upadm/upadm @/path/TABLE_DDL.sql
sqlplus upadm/upadm @/path/INDEX_DDL.sql
sqlplus upadm/upadm @/path/PROCEDURE_DDL.sql
sqlplus upadm/upadm @/path/FUNCTION_DDL.sql
sqlplus upadm/upadm @/path/SEQUENCE_DDL.sql

=========================
sqlplus 
=========================
아래 내용을 파일로 떨구고 test.sql
CONNECT scott/tiger
SPOOL /u01/emp.lst
SET LINESIZE 100
SET PAGESIZE 50
SELECT *
FROM emp;
SPOOL OFF
EXIT;

sqlplus upadm/upadm @/wony/test.sql 로 호출하면 실행됨.

=========================
파일로 떨구지 않고 다이렉트로 실행
=========================
sqlplus -s admin/password << EOF
whenever sqlerror exit sql.sqlcode;
set echo off 
set heading off

@pl_script_1.sql
@pl_script_2.sql

exit;
EOF

